<!DOCTYPE html><html lang="en"><head><title>data</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="data"><meta name="groc-project-path" content="src/data.js"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/data.js</div></div><div id="document"><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'>Method decorator</span></p>

<p>Decorates a DataStore on an Object</p>

<p>Parameters:</p>

<ul>
<li><p><strong>obj must be an Object.</strong><br/>(Object)</p></li>
<li><p><strong>recs can be of any type.</strong><br/>([Optional] Data to set with this.batch)</p></li>
<li><p><strong>args must be an Object.</strong><br/>([Optional] Arguments to set on the store)</p></li>
</ul>

<p><strong>Returns an Object</strong><br/>(Decorated Object)</p></div></div><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">recs</span><span class="p">,</span> <span class="nx">args</span> <span class="p">)</span> <span class="p">{</span>
  <span class="nx">utility</span><span class="p">.</span><span class="nx">genId</span><span class="p">(</span> <span class="nx">obj</span> <span class="p">);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Decorating observer if not present in prototype chain</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">fire</span> <span class="o">!==</span> <span class="s2">&quot;function&quot;</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">observer</span><span class="p">.</span><span class="nx">decorate</span><span class="p">(</span> <span class="nx">obj</span> <span class="p">);</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Creating store</p></div></div><div class="code"><div class="wrapper">  <span class="nx">obj</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataStore</span><span class="p">(</span> <span class="nx">obj</span> <span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nx">args</span> <span class="k">instanceof</span> <span class="nb">Object</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">utility</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">args</span> <span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nx">recs</span> <span class="o">!==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">recs</span> <span class="o">===</span> <span class="s2">&quot;object&quot;</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">obj</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">batch</span><span class="p">(</span> <span class="s2">&quot;set&quot;</span><span class="p">,</span> <span class="nx">recs</span> <span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'>Constructor</span></p>

<p>DataStore</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">DataStore</span> <span class="p">(</span> <span class="nx">obj</span> <span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">autosave</span>    <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">callback</span>    <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">collections</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">credentials</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">datalists</span>   <span class="o">=</span> <span class="p">[];</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">depth</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">events</span>      <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">expires</span>     <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">headers</span>     <span class="o">=</span> <span class="p">{</span><span class="nx">Accept</span><span class="o">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">};</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">ignore</span>      <span class="o">=</span> <span class="p">[];</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">key</span>         <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">keys</span>        <span class="o">=</span> <span class="p">{};</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">leafs</span>       <span class="o">=</span> <span class="p">[];</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">loaded</span>      <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">maxDepth</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">mongodb</span>     <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">parentNode</span>  <span class="o">=</span> <span class="nx">obj</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">pointer</span>     <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">records</span>     <span class="o">=</span> <span class="p">[];</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">retrieve</span>    <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">source</span>      <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">total</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">views</span>       <span class="o">=</span> <span class="p">{};</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">versions</span>    <span class="o">=</span> <span class="p">{};</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">versioning</span>  <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">uri</span>         <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Setting constructor loop</p></div></div><div class="code"><div class="wrapper"><span class="nx">DataStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">DataStore</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'>Method batch</span></p>

<p>Batch sets or deletes data in the store
Events: beforeDataBatch  Fires before the batch is queued
        afterDataBatch   Fires after the batch is queued
        failedDataBatch  Fires when an exception occurs</p>

<p>Parameters:</p>

<ul>
<li><p><strong>type must be a String.</strong><br/>(Type of action to perform ( set/del/delete ))</p></li>
<li><p><strong>data must be an Array.</strong><br/>(Array of keys or indices to delete, or Object containing multiple records to set)</p></li>
<li><p><strong>sync must be a Boolean.</strong><br/>([Optional] Syncs store with data, if true everything is erased)</p></li>
</ul>

<p><strong>Returns an Object</strong><br/>(Deferred)</p></div></div><div class="code"><div class="wrapper"><span class="nx">DataStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">batch</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">sync</span> <span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">regex</span><span class="p">.</span><span class="nx">set_del</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span> <span class="nx">type</span> <span class="p">)</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">sync</span> <span class="o">&amp;&amp;</span> <span class="nx">regex</span><span class="p">.</span><span class="nx">del</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span> <span class="nx">type</span> <span class="p">)</span> <span class="p">)</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">data</span> <span class="o">!==</span> <span class="s2">&quot;object&quot;</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span> <span class="nx">label</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">invalidArguments</span> <span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">sync</span>          <span class="o">=</span> <span class="p">(</span> <span class="nx">sync</span> <span class="o">===</span> <span class="kc">true</span> <span class="p">);</span>
  <span class="kd">var</span> <span class="nx">self</span>      <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
      <span class="nx">events</span>    <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">,</span>
      <span class="nx">defer</span>     <span class="o">=</span> <span class="nx">deferred</span><span class="p">(),</span>
      <span class="nx">deferreds</span> <span class="o">=</span> <span class="p">[];</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nx">events</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">observer</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span> <span class="s2">&quot;beforeDataBatch&quot;</span><span class="p">,</span> <span class="nx">data</span> <span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nx">sync</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">clear</span><span class="p">(</span> <span class="nx">sync</span> <span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">loaded</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nx">events</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">observer</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span> <span class="s2">&quot;afterDataBatch&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">records</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">defer</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">records</span> <span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;del&quot;</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">array</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="nx">data</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">deferreds</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span> <span class="nx">i</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">true</span> <span class="p">)</span> <span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">array</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="nx">data</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">deferreds</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="kc">true</span> <span class="p">)</span> <span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span>

    <span class="nx">utility</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span> <span class="nx">deferreds</span> <span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">loaded</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span> <span class="nx">events</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">observer</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span> <span class="s2">&quot;afterDataBatch&quot;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">records</span> <span class="p">);</span>
      <span class="p">}</span>

      <span class="nx">array</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">datalists</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">i</span><span class="p">.</span><span class="nx">refresh</span><span class="p">();</span>
      <span class="p">});</span>

      <span class="k">if</span> <span class="p">(</span> <span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;del&quot;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">reindex</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">autosave</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="nx">defer</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">records</span> <span class="p">);</span>
    <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">observer</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span> <span class="s2">&quot;failedDataBatch&quot;</span><span class="p">,</span> <span class="nx">e</span> <span class="p">);</span>
      <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span> <span class="nx">e</span> <span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">defer</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'>Method buildUri</span></p>

<p>Builds a relative URI</p>

<p>Parameters:</p>

<ul>
<li><strong>key must be a String.</strong><br/>(Record key)</li>
</ul>

<p><strong>Returns a String</strong><br/>([description])</p></div></div><div class="code"><div class="wrapper"><span class="nx">DataStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">buildUri</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">parsed</span> <span class="o">=</span> <span class="nx">utility</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span> <span class="p">);</span>

  <span class="k">return</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">+</span> <span class="s2">&quot;//&quot;</span> <span class="o">+</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">host</span> <span class="o">+</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">+</span> <span class="p">(</span> <span class="nx">regex</span><span class="p">.</span><span class="nx">endslash</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">pathname</span> <span class="p">)</span> <span class="o">?</span> <span class="s2">&quot;&quot;</span> <span class="o">:</span> <span class="s2">&quot;/&quot;</span> <span class="p">)</span> <span class="o">+</span> <span class="nx">key</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'>Method clear</span></p>

<p>Clears the data object, unsets the uri property
Events: beforeDataClear Fires before the data is cleared
        afterDataClear  Fires after the data is cleared</p>

<p>Parameters:</p>

<ul>
<li><strong>sync must be a Boolean.</strong><br/>([Optional] Boolean to limit clearing of properties)</li>
</ul>

<p><strong>Returns an Object</strong><br/>(Data store)</p></div></div><div class="code"><div class="wrapper"><span class="nx">DataStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">clear</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">sync</span> <span class="p">)</span> <span class="p">{</span>
  <span class="nx">sync</span>       <span class="o">=</span> <span class="p">(</span> <span class="nx">sync</span> <span class="o">===</span> <span class="kc">true</span> <span class="p">);</span>
  <span class="kd">var</span> <span class="nx">events</span> <span class="o">=</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">events</span> <span class="o">===</span> <span class="kc">true</span> <span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">sync</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">events</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">observer</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span> <span class="s2">&quot;beforeDataClear&quot;</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">array</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">datalists</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">i</span><span class="p">.</span><span class="nx">teardown</span><span class="p">(</span> <span class="kc">true</span> <span class="p">);</span>
    <span class="p">});</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">autosave</span>    <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">callback</span>    <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">collections</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">credentials</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">datalists</span>   <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">depth</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">events</span>      <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">expires</span>     <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">headers</span>     <span class="o">=</span> <span class="p">{</span><span class="nx">Accept</span><span class="o">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ignore</span>      <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">key</span>         <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">keys</span>        <span class="o">=</span> <span class="p">{};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">leafs</span>       <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">loaded</span>      <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">maxDepth</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">pointer</span>     <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">records</span>     <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">retrieve</span>    <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">source</span>      <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">total</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">versions</span>    <span class="o">=</span> <span class="p">{};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">versioning</span>  <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">views</span>       <span class="o">=</span> <span class="p">{};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">uri</span>         <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nx">events</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">observer</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span> <span class="s2">&quot;afterDataClear&quot;</span> <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">collections</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">keys</span>        <span class="o">=</span> <span class="p">{};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">loaded</span>      <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">records</span>     <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">total</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">versions</span>    <span class="o">=</span> <span class="p">{};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">views</span>       <span class="o">=</span> <span class="p">{};</span>

    <span class="nx">array</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">datalists</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">i</span><span class="p">.</span><span class="nx">refresh</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'>Method crawl</span></p>

<p>Crawls a record's properties and creates DataStores when URIs are detected
Events: beforeDataRetrieve Fires before crawling a record
        afterDataRetrieve  Fires after the store has retrieved all data from crawling
        failedDataRetrieve Fires if an exception occurs</p>

<p>Parameters:</p>

<ul>
<li><strong>arg can be of any type.</strong><br/>(Record, key or index)</li>
</ul>

<p><strong>Returns an Object</strong><br/>(Deferred)</p></div></div><div class="code"><div class="wrapper"><span class="nx">DataStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">crawl</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">arg</span> <span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">self</span>      <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
      <span class="nx">events</span>    <span class="o">=</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">events</span> <span class="o">===</span> <span class="kc">true</span> <span class="p">),</span>
      <span class="nx">record</span>    <span class="o">=</span> <span class="p">(</span> <span class="nx">arg</span> <span class="k">instanceof</span> <span class="nb">Object</span> <span class="p">)</span> <span class="o">?</span> <span class="nx">arg</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="nx">arg</span> <span class="p">),</span>
      <span class="nx">defer</span>     <span class="o">=</span> <span class="nx">deferred</span><span class="p">(),</span>
      <span class="nx">deferreds</span> <span class="o">=</span> <span class="p">[],</span>
      <span class="nx">parsed</span>    <span class="o">=</span> <span class="nx">utility</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span> <span class="o">||</span> <span class="s2">&quot;&quot;</span> <span class="p">),</span>
      <span class="nx">clone</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">record</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span> <span class="nx">label</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">invalidArguments</span> <span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nx">events</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">observer</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span> <span class="s2">&quot;beforeDataRetrieve&quot;</span><span class="p">,</span> <span class="nx">record</span> <span class="p">);</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>An Array is considered a collection</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="p">(</span> <span class="nx">record</span><span class="p">.</span><span class="nx">data</span> <span class="k">instanceof</span> <span class="nb">Array</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">clone</span>       <span class="o">=</span> <span class="nx">utility</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">record</span><span class="p">.</span><span class="nx">data</span> <span class="p">);</span>
    <span class="nx">record</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="nx">array</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="nx">clone</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">i</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span> <span class="sr">/.*\//</span><span class="p">,</span> <span class="s2">&quot;&quot;</span> <span class="p">),</span>
          <span class="nx">uri</span><span class="p">;</span>

      <span class="nx">record</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">data</span><span class="p">(</span> <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="nx">record</span><span class="p">.</span><span class="nx">key</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="nx">key</span><span class="p">},</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span><span class="nx">key</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="nx">pointer</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">pointer</span><span class="p">,</span> <span class="nx">source</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">source</span><span class="p">,</span> <span class="nx">ignore</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">ignore</span><span class="p">.</span><span class="nx">slice</span><span class="p">(),</span> <span class="nx">leafs</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">leafs</span><span class="p">.</span><span class="nx">slice</span><span class="p">(),</span> <span class="nx">depth</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">maxDepth</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">maxDepth</span><span class="p">,</span> <span class="nx">headers</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">headers</span><span class="p">,</span> <span class="nx">retrieve</span><span class="o">:</span> <span class="kc">true</span><span class="p">}</span> <span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span> <span class="nx">i</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span> <span class="s2">&quot;//&quot;</span> <span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Relative path to store, i.e. a child</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span> <span class="nx">i</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span> <span class="mi">0</span> <span class="p">)</span> <span class="o">!==</span> <span class="s2">&quot;/&quot;</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">uri</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">buildUri</span><span class="p">(</span> <span class="nx">i</span> <span class="p">);</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Root path, relative to store, i.e. a domain</p></div></div><div class="code"><div class="wrapper">        <span class="k">else</span> <span class="p">{</span>
          <span class="nx">uri</span> <span class="o">=</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">+</span> <span class="s2">&quot;//&quot;</span> <span class="o">+</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">host</span> <span class="o">+</span> <span class="nx">i</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">uri</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="nx">deferreds</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">record</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">data</span><span class="p">.</span><span class="nx">setUri</span><span class="p">(</span> <span class="nx">uri</span> <span class="p">)</span> <span class="p">);</span>
    <span class="p">}</span> <span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Depth of recursion is controled by <code>maxDepth</code></p></div></div><div class="code"><div class="wrapper">    <span class="nx">utility</span><span class="p">.</span><span class="nx">iterate</span><span class="p">(</span> <span class="nx">record</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">k</span> <span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">uri</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span> <span class="nx">array</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">ignore</span><span class="p">,</span> <span class="nx">k</span> <span class="p">)</span> <span class="o">||</span> <span class="nx">array</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">leafs</span><span class="p">,</span> <span class="nx">k</span> <span class="p">)</span> <span class="o">||</span> <span class="nx">self</span><span class="p">.</span><span class="nx">depth</span> <span class="o">&gt;=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">maxDepth</span> <span class="o">||</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="nx">v</span> <span class="k">instanceof</span> <span class="nb">Array</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">v</span> <span class="o">!==</span> <span class="s2">&quot;string&quot;</span> <span class="p">)</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">v</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span> <span class="s2">&quot;//&quot;</span> <span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">v</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span> <span class="mi">0</span> <span class="p">)</span> <span class="o">!==</span> <span class="s2">&quot;/&quot;</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="nx">array</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">collections</span><span class="p">,</span> <span class="nx">k</span> <span class="p">);</span>

      <span class="nx">record</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">data</span><span class="p">(</span> <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="nx">record</span><span class="p">.</span><span class="nx">key</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="nx">k</span><span class="p">},</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span><span class="nx">key</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="nx">pointer</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">pointer</span><span class="p">,</span> <span class="nx">source</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">source</span><span class="p">,</span> <span class="nx">ignore</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">ignore</span><span class="p">.</span><span class="nx">slice</span><span class="p">(),</span> <span class="nx">leafs</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">leafs</span><span class="p">.</span><span class="nx">slice</span><span class="p">(),</span> <span class="nx">depth</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">maxDepth</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">maxDepth</span><span class="p">,</span> <span class="nx">headers</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">headers</span><span class="p">,</span> <span class="nx">retrieve</span><span class="o">:</span> <span class="kc">true</span><span class="p">}</span> <span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">array</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">leafs</span><span class="p">,</span> <span class="nx">k</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nx">record</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">k</span><span class="p">].</span><span class="nx">data</span><span class="p">.</span><span class="nx">maxDepth</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">record</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">k</span><span class="p">].</span><span class="nx">data</span><span class="p">.</span><span class="nx">depth</span> <span class="o">&lt;=</span> <span class="nx">record</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">k</span><span class="p">].</span><span class="nx">data</span><span class="p">.</span><span class="nx">maxDepth</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">v</span> <span class="k">instanceof</span> <span class="nb">Array</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">deferreds</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">record</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">k</span><span class="p">].</span><span class="nx">data</span><span class="p">.</span><span class="nx">batch</span><span class="p">(</span> <span class="s2">&quot;set&quot;</span><span class="p">,</span> <span class="nx">v</span> <span class="p">)</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span> <span class="nx">v</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span> <span class="s2">&quot;//&quot;</span> <span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Relative path to store, i.e. a child</p></div></div><div class="code"><div class="wrapper">            <span class="k">if</span> <span class="p">(</span> <span class="nx">v</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span> <span class="mi">0</span> <span class="p">)</span> <span class="o">!==</span> <span class="s2">&quot;/&quot;</span> <span class="p">)</span> <span class="p">{</span>
              <span class="nx">uri</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">buildUri</span><span class="p">(</span> <span class="nx">v</span> <span class="p">);</span>
            <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Root path, relative to store, i.e. a domain</p></div></div><div class="code"><div class="wrapper">            <span class="k">else</span> <span class="p">{</span>
              <span class="nx">uri</span> <span class="o">=</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">+</span> <span class="s2">&quot;//&quot;</span> <span class="o">+</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">host</span> <span class="o">+</span> <span class="nx">v</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="p">{</span>
            <span class="nx">uri</span> <span class="o">=</span> <span class="nx">v</span><span class="p">;</span>
          <span class="p">}</span>

          <span class="nx">deferreds</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">record</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">k</span><span class="p">].</span><span class="nx">data</span><span class="p">.</span><span class="nx">setUri</span><span class="p">(</span> <span class="nx">uri</span> <span class="p">)</span> <span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nx">deferreds</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">utility</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span> <span class="nx">deferreds</span> <span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">events</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">observer</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span> <span class="s2">&quot;afterDataRetrieve&quot;</span><span class="p">,</span> <span class="nx">record</span> <span class="p">);</span>
      <span class="p">}</span>

      <span class="nx">defer</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span> <span class="nx">record</span> <span class="p">);</span>
    <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">events</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">observer</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span> <span class="s2">&quot;failedDataRetrieve&quot;</span><span class="p">,</span> <span class="nx">record</span> <span class="p">);</span>
      <span class="p">}</span>

      <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span> <span class="nx">e</span> <span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">events</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">observer</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span> <span class="s2">&quot;afterDataRetrieve&quot;</span><span class="p">,</span> <span class="nx">record</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">defer</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span> <span class="nx">record</span> <span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">defer</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'>Method del</span></p>

<p>Deletes a record based on key or index
Events: beforeDataDelete  Fires before the record is deleted
        afterDataDelete   Fires after the record is deleted
        failedDataDelete  Fires if the store is RESTful and the action is denied</p>

<p>Parameters:</p>

<ul>
<li><p><strong>record can be of any type.</strong><br/>(Record, key or index)</p></li>
<li><p><strong>reindex must be a Boolean.</strong><br/>([Optional] <code>true</code> if DataStore should be reindexed)</p></li>
<li><p><strong>batch must be a Boolean.</strong><br/>([Optional] <code>true</code> if part of a batch operation)</p></li>
</ul>

<p><strong>Returns an Object</strong><br/>(Deferred)</p></div></div><div class="code"><div class="wrapper"><span class="nx">DataStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">del</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">reindex</span><span class="p">,</span> <span class="nx">batch</span> <span class="p">)</span> <span class="p">{</span>
  <span class="nx">record</span>    <span class="o">=</span> <span class="nx">record</span><span class="p">.</span><span class="nx">key</span> <span class="o">?</span> <span class="nx">record</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span> <span class="p">(</span> <span class="nx">record</span> <span class="p">);</span>
  <span class="nx">reindex</span>   <span class="o">=</span> <span class="p">(</span> <span class="nx">reindex</span> <span class="o">!==</span> <span class="kc">false</span> <span class="p">);</span>
  <span class="nx">batch</span>     <span class="o">=</span> <span class="p">(</span> <span class="nx">batch</span> <span class="o">===</span> <span class="kc">true</span> <span class="p">);</span>
  <span class="kd">var</span> <span class="nx">self</span>  <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
      <span class="nx">defer</span> <span class="o">=</span> <span class="nx">deferred</span><span class="p">();</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nx">record</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span> <span class="nx">label</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">invalidArguments</span> <span class="p">)</span> <span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">events</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">observer</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span> <span class="s2">&quot;beforeDataDelete&quot;</span><span class="p">,</span> <span class="nx">record</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">callback</span> <span class="o">!==</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">delComplete</span><span class="p">(</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">reindex</span><span class="p">,</span> <span class="nx">batch</span><span class="p">,</span> <span class="nx">defer</span> <span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">client</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">buildUri</span><span class="p">(</span> <span class="nx">record</span><span class="p">.</span><span class="nx">key</span> <span class="p">),</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">delComplete</span><span class="p">(</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">reindex</span><span class="p">,</span> <span class="nx">batch</span><span class="p">,</span> <span class="nx">defer</span> <span class="p">);</span>
      <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">observer</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span> <span class="s2">&quot;failedDataDelete&quot;</span><span class="p">,</span> <span class="nx">e</span> <span class="p">);</span>
        <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span> <span class="nx">e</span> <span class="p">);</span>
      <span class="p">},</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">utility</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span> <span class="p">{</span><span class="nx">withCredentials</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">credentials</span><span class="p">},</span> <span class="k">this</span><span class="p">.</span><span class="nx">headers</span> <span class="p">)</span> <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">defer</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'>Method delComplete</span></p>

<p>Delete completion</p>

<p>Parameters:</p>

<ul>
<li><p><strong>record must be an Object.</strong><br/>(DataStore record)</p></li>
<li><p><strong>reindex must be a Boolean.</strong><br/>(<code>true</code> if DataStore should be reindexed)</p></li>
<li><p><strong>batch must be a Boolean.</strong><br/>(<code>true</code> if part of a batch operation)</p></li>
<li><p><strong>defer must be an Object.</strong><br/>(Deferred instance)</p></li>
</ul>

<p><strong>Returns an Object</strong><br/>(DataStore instance)</p></div></div><div class="code"><div class="wrapper"><span class="nx">DataStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">delComplete</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">reindex</span><span class="p">,</span> <span class="nx">batch</span><span class="p">,</span> <span class="nx">defer</span> <span class="p">)</span> <span class="p">{</span>
  <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">keys</span><span class="p">[</span><span class="nx">record</span><span class="p">.</span><span class="nx">key</span><span class="p">];</span>
  <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">versions</span><span class="p">[</span><span class="nx">record</span><span class="p">.</span><span class="nx">key</span><span class="p">];</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">records</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span> <span class="nx">record</span><span class="p">.</span><span class="nx">index</span> <span class="p">);</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">total</span><span class="o">--</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">views</span> <span class="o">=</span> <span class="p">{};</span>

  <span class="nx">array</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">collections</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">record</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">teardown</span><span class="p">();</span>
  <span class="p">});</span>

  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">batch</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">reindex</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">reindex</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">autosave</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">purge</span><span class="p">(</span> <span class="nx">record</span><span class="p">.</span><span class="nx">key</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">events</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">observer</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span> <span class="s2">&quot;afterDataDelete&quot;</span><span class="p">,</span> <span class="nx">record</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">array</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">datalists</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">i</span><span class="p">.</span><span class="nx">refresh</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">defer</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span> <span class="nx">record</span><span class="p">.</span><span class="nx">key</span> <span class="p">);</span>

  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments doc-section doc-section-public"><div class="wrapper"><p><span class='doc-section-header'>Public method dump</span></p>

<p>Exports a subset or complete record set of DataStore</p>

<p>Parameters:</p>

<ul>
<li><p><strong>args must be an Array.</strong><br/>([Optional] Sub-data set of DataStore)</p></li>
<li><p><strong>fields must be an Array.</strong><br/>([Optional] Fields to export, defaults to all)</p></li>
</ul>

<p><strong>Returns an Array</strong><br/>(Records)</p></div></div><div class="code"><div class="wrapper"><span class="nx">DataStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">dump</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">fields</span> <span class="p">)</span> <span class="p">{</span>
  <span class="nx">args</span>       <span class="o">=</span> <span class="nx">args</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">records</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">self</span>   <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
      <span class="nx">custom</span> <span class="o">=</span> <span class="p">(</span> <span class="nx">fields</span> <span class="k">instanceof</span> <span class="nb">Array</span> <span class="o">&amp;&amp;</span> <span class="nx">fields</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">),</span>
      <span class="nx">key</span>    <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">key</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">fn</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nx">custom</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">fn</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">record</span> <span class="o">=</span> <span class="p">{};</span>

      <span class="nx">array</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="nx">fields</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">f</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">record</span><span class="p">[</span><span class="nx">f</span><span class="p">]</span> <span class="o">=</span> <span class="nx">f</span> <span class="o">===</span> <span class="nx">self</span><span class="p">.</span><span class="nx">key</span> <span class="o">?</span> <span class="nx">i</span><span class="p">.</span><span class="nx">key</span> <span class="o">:</span> <span class="p">(</span> <span class="o">!</span><span class="nx">array</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">collections</span><span class="p">,</span> <span class="nx">f</span> <span class="p">)</span> <span class="o">?</span> <span class="nx">utility</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">i</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">f</span><span class="p">],</span> <span class="kc">true</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">i</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">f</span><span class="p">].</span><span class="nx">data</span><span class="p">.</span><span class="nx">uri</span> <span class="p">);</span>
      <span class="p">});</span>

      <span class="k">return</span> <span class="nx">record</span><span class="p">;</span>
    <span class="p">};</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="nx">fn</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">record</span> <span class="o">=</span> <span class="p">{};</span>

      <span class="k">if</span> <span class="p">(</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">record</span><span class="p">[</span><span class="nx">self</span><span class="p">.</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">i</span><span class="p">.</span><span class="nx">key</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="nx">utility</span><span class="p">.</span><span class="nx">iterate</span><span class="p">(</span> <span class="nx">i</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">k</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">record</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">!</span><span class="nx">array</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">collections</span><span class="p">,</span> <span class="nx">k</span> <span class="p">)</span> <span class="o">?</span> <span class="nx">utility</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">v</span><span class="p">,</span> <span class="kc">true</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">v</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">uri</span><span class="p">;</span>
      <span class="p">});</span>

      <span class="k">return</span> <span class="nx">record</span><span class="p">;</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">args</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="nx">fn</span> <span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'>Method find</span></p>

<p>Finds needle in the haystack</p>

<p>Parameters:</p>

<ul>
<li><p><strong>needle can be of any type.</strong><br/>(String, Number, RegExp Pattern or Function)</p></li>
<li><p><strong>haystack must be a String.</strong><br/>([Optional] Commma delimited string of the field( s ) to search)</p></li>
<li><p><strong>modifiers must be a String.</strong><br/>([Optional] Regex modifiers, defaults to "gi" unless value is null)</p></li>
</ul>

<p><strong>Returns an Array</strong><br/>(Array of results)</p></div></div><div class="code"><div class="wrapper"><span class="nx">DataStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">find</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">needle</span><span class="p">,</span> <span class="nx">haystack</span><span class="p">,</span> <span class="nx">modifiers</span> <span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span> <span class="nx">needle</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span> <span class="nx">label</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">invalidArguments</span> <span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[],</span>
      <span class="nx">keys</span>   <span class="o">=</span> <span class="p">[],</span>
      <span class="nx">regex</span>  <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(),</span>
      <span class="nx">fn</span>     <span class="o">=</span> <span class="k">typeof</span> <span class="nx">needle</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Blocking unnecessary ops</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">total</span> <span class="o">===</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Preparing parameters</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">fn</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">needle</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">needle</span> <span class="o">===</span> <span class="s2">&quot;string&quot;</span> <span class="o">?</span> <span class="nx">string</span><span class="p">.</span><span class="nx">explode</span><span class="p">(</span> <span class="nx">needle</span> <span class="p">)</span> <span class="o">:</span> <span class="p">[</span><span class="nx">needle</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nx">modifiers</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">string</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span> <span class="nx">modifiers</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">modifiers</span> <span class="o">=</span> <span class="s2">&quot;gi&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">modifiers</span> <span class="o">===</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">modifiers</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">haystack</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">haystack</span> <span class="o">===</span> <span class="s2">&quot;string&quot;</span> <span class="o">?</span> <span class="nx">string</span><span class="p">.</span><span class="nx">explode</span><span class="p">(</span> <span class="nx">haystack</span> <span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>No haystack, testing everything</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="p">(</span> <span class="nx">haystack</span> <span class="o">===</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">array</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">records</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">r</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">fn</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">utility</span><span class="p">.</span><span class="nx">iterate</span><span class="p">(</span> <span class="nx">r</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">v</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span> <span class="nx">array</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span> <span class="nx">keys</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
          <span class="p">}</span>

          <span class="k">if</span> <span class="p">(</span> <span class="nx">v</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">v</span><span class="p">.</span><span class="nx">data</span> <span class="o">===</span> <span class="s2">&quot;object&quot;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
          <span class="p">}</span>

          <span class="nx">array</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="nx">needle</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">n</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">utility</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span> <span class="nx">regex</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">modifiers</span> <span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">regex</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span> <span class="nx">v</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
              <span class="nx">keys</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">r</span><span class="p">.</span><span class="nx">key</span> <span class="p">);</span>
              <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">r</span> <span class="p">);</span>

              <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">});</span>
        <span class="p">});</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">needle</span><span class="p">(</span> <span class="nx">r</span> <span class="p">)</span> <span class="o">===</span> <span class="kc">true</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">keys</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">r</span><span class="p">.</span><span class="nx">key</span> <span class="p">);</span>
        <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">r</span> <span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Looking through the haystack</p></div></div><div class="code"><div class="wrapper">  <span class="k">else</span> <span class="p">{</span>
    <span class="nx">array</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">records</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">r</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">array</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="nx">haystack</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">h</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">array</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span> <span class="nx">keys</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span> <span class="nx">r</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">h</span><span class="p">]</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">r</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">h</span><span class="p">].</span><span class="nx">data</span> <span class="o">===</span> <span class="s2">&quot;object&quot;</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">fn</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">array</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="nx">needle</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">n</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">utility</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span> <span class="nx">regex</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">modifiers</span> <span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span> <span class="nx">regex</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span> <span class="nx">r</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">h</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
              <span class="nx">keys</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">r</span><span class="p">.</span><span class="nx">key</span> <span class="p">);</span>
              <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">r</span> <span class="p">);</span>

              <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">});</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">needle</span><span class="p">(</span> <span class="nx">r</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">h</span><span class="p">]</span> <span class="p">)</span> <span class="o">===</span> <span class="kc">true</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">keys</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">r</span><span class="p">.</span><span class="nx">key</span> <span class="p">);</span>
          <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">r</span> <span class="p">);</span>

          <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'>Method get</span></p>

<p>Retrieves a record based on key or index
If the key is an integer, cast to a string before sending as an argument!</p>

<p>Parameters:</p>

<ul>
<li><p><strong>record can be of any type.</strong><br/>(Key, index or Array of pagination start &amp; end; or comma delimited String of keys or indices)</p></li>
<li><p><strong>offset must be a Number.</strong><br/>([Optional] Offset from <code>record</code> for pagination)</p></li>
</ul>

<p><strong>Returns a Mixed</strong><br/>(Individual record, or Array of records)</p></div></div><div class="code"><div class="wrapper"><span class="nx">DataStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">get</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">offset</span> <span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">records</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">records</span><span class="p">,</span>
      <span class="nx">type</span>    <span class="o">=</span> <span class="k">typeof</span> <span class="nx">record</span><span class="p">,</span>
      <span class="nx">self</span>    <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
      <span class="nx">r</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;undefined&quot;</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">r</span> <span class="o">=</span> <span class="nx">records</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;string&quot;</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">record</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span> <span class="s2">&quot;,&quot;</span> <span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">r</span> <span class="o">=</span> <span class="nx">records</span><span class="p">[</span><span class="nx">self</span><span class="p">.</span><span class="nx">keys</span><span class="p">[</span><span class="nx">record</span><span class="p">]];</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">r</span> <span class="o">=</span> <span class="nx">string</span><span class="p">.</span><span class="nx">explode</span><span class="p">(</span> <span class="nx">record</span> <span class="p">).</span><span class="nx">map</span><span class="p">(</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">records</span><span class="p">[</span><span class="nb">parseInt</span><span class="p">(</span> <span class="nx">i</span><span class="p">,</span> <span class="mi">10</span> <span class="p">)];</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">records</span><span class="p">[</span><span class="nx">self</span><span class="p">.</span><span class="nx">keys</span><span class="p">[</span><span class="nx">i</span><span class="p">]];</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;number&quot;</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nb">isNaN</span><span class="p">(</span> <span class="nx">offset</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">r</span> <span class="o">=</span> <span class="nx">records</span><span class="p">[</span><span class="nb">parseInt</span><span class="p">(</span> <span class="nx">record</span><span class="p">,</span> <span class="mi">10</span> <span class="p">)];</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">r</span> <span class="o">=</span> <span class="nx">array</span><span class="p">.</span><span class="nx">limit</span><span class="p">(</span> <span class="nx">records</span><span class="p">,</span> <span class="nb">parseInt</span><span class="p">(</span> <span class="nx">record</span><span class="p">,</span> <span class="mi">10</span> <span class="p">),</span> <span class="nb">parseInt</span><span class="p">(</span> <span class="nx">offset</span><span class="p">,</span> <span class="mi">10</span> <span class="p">)</span> <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">r</span><span class="p">;</span>
<span class="p">},</span></div></div></div><div class="segment"><div class="comments doc-section doc-section-public"><div class="wrapper"><p><span class='doc-section-header'>Public method join</span></p>

<p>Performs an (INNER/LEFT/RIGHT) JOIN on two DataStores</p>

<p>Parameters:</p>

<ul>
<li><p><strong>arg must be a String.</strong><br/>(DataStore to join)</p></li>
<li><p><strong>field must be a String.</strong><br/>(Field in both DataStores)</p></li>
<li><p><strong>join must be a String.</strong><br/>(Type of JOIN to perform, defaults to <code>inner</code>)</p></li>
</ul>

<p><strong>Returns an Array</strong><br/>(Array of records)</p></div></div><div class="code"><div class="wrapper"><span class="nx">DataStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">join</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">arg</span><span class="p">,</span> <span class="nx">field</span><span class="p">,</span> <span class="nx">join</span> <span class="p">)</span> <span class="p">{</span>
  <span class="nx">join</span>        <span class="o">=</span> <span class="nx">join</span> <span class="o">||</span> <span class="s2">&quot;inner&quot;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">self</span>    <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
      <span class="nx">results</span> <span class="o">=</span> <span class="p">[],</span>
      <span class="nx">key</span>     <span class="o">=</span> <span class="nx">field</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span>
      <span class="nx">keys</span>    <span class="o">=</span> <span class="nx">array</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span> <span class="nx">array</span><span class="p">.</span><span class="nx">cast</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">records</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">data</span><span class="p">,</span> <span class="kc">true</span> <span class="p">),</span> <span class="nx">array</span><span class="p">.</span><span class="nx">cast</span><span class="p">(</span> <span class="nx">arg</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">records</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">data</span><span class="p">,</span> <span class="kc">true</span> <span class="p">)</span> <span class="p">),</span>
    <span class="nx">fn</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nx">join</span> <span class="o">===</span> <span class="s2">&quot;inner&quot;</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">fn</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">where</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="nx">match</span><span class="p">;</span>

      <span class="nx">where</span><span class="p">[</span><span class="nx">field</span><span class="p">]</span> <span class="o">=</span> <span class="nx">key</span> <span class="o">?</span> <span class="nx">i</span><span class="p">.</span><span class="nx">key</span> <span class="o">:</span> <span class="nx">i</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">field</span><span class="p">];</span>
      <span class="nx">match</span>        <span class="o">=</span> <span class="nx">arg</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span> <span class="nx">where</span> <span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span> <span class="nx">match</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span> <span class="nx">label</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">databaseMoreThanOne</span> <span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">match</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">utility</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span> <span class="nx">utility</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">i</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="kc">true</span> <span class="p">),</span> <span class="nx">utility</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">data</span><span class="p">,</span> <span class="kc">true</span> <span class="p">)</span> <span class="p">)</span> <span class="p">);</span>
      <span class="p">}</span>
    <span class="p">};</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">join</span> <span class="o">===</span> <span class="s2">&quot;left&quot;</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">fn</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">where</span>  <span class="o">=</span> <span class="p">{},</span>
          <span class="nx">record</span> <span class="o">=</span> <span class="nx">utility</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">i</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="kc">true</span> <span class="p">),</span>
        <span class="nx">match</span><span class="p">;</span>

      <span class="nx">where</span><span class="p">[</span><span class="nx">field</span><span class="p">]</span> <span class="o">=</span> <span class="nx">key</span> <span class="o">?</span> <span class="nx">i</span><span class="p">.</span><span class="nx">key</span> <span class="o">:</span> <span class="nx">i</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">field</span><span class="p">];</span>
      <span class="nx">match</span>        <span class="o">=</span> <span class="nx">arg</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span> <span class="nx">where</span> <span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span> <span class="nx">match</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span> <span class="nx">label</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">databaseMoreThanOne</span> <span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">match</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">utility</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span> <span class="nx">utility</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">record</span><span class="p">,</span> <span class="kc">true</span> <span class="p">),</span> <span class="nx">utility</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">data</span><span class="p">,</span> <span class="kc">true</span> <span class="p">)</span> <span class="p">)</span> <span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">array</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="nx">keys</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span> <span class="nx">record</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">record</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">record</span> <span class="p">);</span>
      <span class="p">}</span>
    <span class="p">};</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">join</span> <span class="o">===</span> <span class="s2">&quot;right&quot;</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">fn</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">where</span>  <span class="o">=</span> <span class="p">{},</span>
          <span class="nx">record</span> <span class="o">=</span> <span class="nx">utility</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">i</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="kc">true</span> <span class="p">),</span>
        <span class="nx">match</span><span class="p">;</span>

      <span class="nx">where</span><span class="p">[</span><span class="nx">field</span><span class="p">]</span> <span class="o">=</span> <span class="nx">key</span> <span class="o">?</span> <span class="nx">i</span><span class="p">.</span><span class="nx">key</span> <span class="o">:</span> <span class="nx">i</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">field</span><span class="p">];</span>
      <span class="nx">match</span>        <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span> <span class="nx">where</span> <span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span> <span class="nx">match</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span> <span class="nx">label</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">databaseMoreThanOne</span> <span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">match</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">utility</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span> <span class="nx">utility</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">record</span><span class="p">,</span> <span class="kc">true</span> <span class="p">),</span> <span class="nx">utility</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">data</span><span class="p">,</span> <span class="kc">true</span> <span class="p">)</span> <span class="p">)</span> <span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">array</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="nx">keys</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span> <span class="nx">record</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">record</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">record</span> <span class="p">);</span>
      <span class="p">}</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="nx">array</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="nx">join</span> <span class="o">===</span> <span class="s2">&quot;right&quot;</span> <span class="o">?</span> <span class="nx">arg</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">records</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">records</span><span class="p">,</span> <span class="nx">fn</span><span class="p">);</span>

  <span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'>Method only</span></p>

<p>Retrieves only 1 field/property</p>

<p>Parameters:</p>

<ul>
<li><strong>arg must be a String.</strong><br/>(Field/property to retrieve)</li>
</ul>

<p><strong>Returns an Array</strong><br/>(Array of values)</p></div></div><div class="code"><div class="wrapper"><span class="nx">DataStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">only</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">arg</span> <span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span> <span class="nx">arg</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">key</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">records</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">i</span><span class="p">.</span><span class="nx">key</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">records</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">i</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">arg</span><span class="p">];</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'>Method purge</span></p>

<p>Purges DataStore or record from localStorage</p>

<p>Parameters:</p>

<ul>
<li><strong>arg can be of any type.</strong><br/>([Optional] String or Number for record)</li>
</ul>

<p><strong>Returns an Object</strong><br/>(Record or store)</p></div></div><div class="code"><div class="wrapper"><span class="nx">DataStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">purge</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">arg</span> <span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">storage</span><span class="p">(</span> <span class="nx">arg</span> <span class="o">||</span> <span class="k">this</span><span class="p">,</span> <span class="s2">&quot;remove&quot;</span> <span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'>Method reindex</span></p>

<p>Reindexes the DataStore</p>

<p><strong>Returns an Object</strong><br/>(Data store)</p></div></div><div class="code"><div class="wrapper"><span class="nx">DataStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reindex</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">nth</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">total</span><span class="p">,</span>
      <span class="nx">i</span>   <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">views</span> <span class="o">=</span> <span class="p">{};</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nx">nth</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span> <span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">nth</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">records</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">index</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">keys</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">records</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'>Method restore</span></p>

<p>Restores DataStore or record frome localStorage</p>

<p>Parameters:</p>

<ul>
<li><strong>arg can be of any type.</strong><br/>([Optional] String or Number for record)</li>
</ul>

<p><strong>Returns an Object</strong><br/>(Record or store)</p></div></div><div class="code"><div class="wrapper"><span class="nx">DataStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">restore</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">arg</span> <span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">storage</span><span class="p">(</span> <span class="nx">arg</span> <span class="o">||</span> <span class="k">this</span><span class="p">,</span> <span class="s2">&quot;get&quot;</span> <span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'>Method save</span></p>

<p>Saves DataStore or record to localStorage, sessionStorage or MongoDB (node.js only)</p>

<p>Parameters:</p>

<ul>
<li><strong>arg can be of any type.</strong><br/>([Optional] String or Number for record)</li>
</ul>

<p><strong>Returns an Object</strong><br/>(Deferred)</p></div></div><div class="code"><div class="wrapper"><span class="nx">DataStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">save</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">arg</span> <span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">storage</span><span class="p">(</span> <span class="nx">arg</span> <span class="o">||</span> <span class="k">this</span><span class="p">,</span> <span class="s2">&quot;set&quot;</span> <span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'>Method select</span></p>

<p>Selects records based on an explcit description</p>

<p>Parameters:</p>

<ul>
<li><strong>where must be an Object.</strong><br/>(Object describing the WHERE clause)</li>
</ul>

<p><strong>Returns an Array</strong><br/>(Array of records)</p></div></div><div class="code"><div class="wrapper"><span class="nx">DataStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">select</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">where</span> <span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">clauses</span> <span class="o">=</span> <span class="nx">array</span><span class="p">.</span><span class="nx">fromObject</span><span class="p">(</span> <span class="nx">where</span> <span class="p">),</span>
      <span class="nx">cond</span>    <span class="o">=</span> <span class="s2">&quot;return ( &quot;</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nx">clauses</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">array</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="nx">clauses</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">idx</span> <span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">b1</span> <span class="o">=</span> <span class="s2">&quot;( &quot;</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span> <span class="nx">idx</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">b1</span> <span class="o">=</span> <span class="s2">&quot; &amp;&amp; ( &quot;</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span> <span class="nx">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">instanceof</span> <span class="nb">Function</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">cond</span> <span class="o">+=</span> <span class="nx">b1</span> <span class="o">+</span> <span class="nx">i</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">toString</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;( rec.data[\&quot;&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;\&quot;] ) )&quot;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span> <span class="nx">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">cond</span> <span class="o">+=</span> <span class="nx">b1</span> <span class="o">+</span> <span class="s2">&quot;rec.data[\&quot;&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;\&quot;] === &quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; )&quot;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">cond</span> <span class="o">+=</span> <span class="nx">b1</span> <span class="o">+</span> <span class="s2">&quot;rec.data[\&quot;&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;\&quot;] === \&quot;&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;\&quot; )&quot;</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">clauses</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">instanceof</span> <span class="nb">Function</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">cond</span> <span class="o">+=</span> <span class="nx">clauses</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">].</span><span class="nx">toString</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;( rec.data[\&quot;&quot;</span> <span class="o">+</span> <span class="nx">clauses</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;\&quot;] )&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span> <span class="nx">clauses</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">cond</span> <span class="o">+=</span> <span class="s2">&quot;rec.data[\&quot;&quot;</span> <span class="o">+</span> <span class="nx">clauses</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;\&quot;] === &quot;</span> <span class="o">+</span> <span class="nx">clauses</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">cond</span> <span class="o">+=</span> <span class="s2">&quot;rec.data[\&quot;&quot;</span> <span class="o">+</span> <span class="nx">clauses</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;\&quot;] === \&quot;&quot;</span> <span class="o">+</span> <span class="nx">clauses</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;\&quot;&quot;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">cond</span> <span class="o">+=</span> <span class="s2">&quot; );&quot;</span><span class="p">;</span>

  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">records</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span> <span class="k">new</span> <span class="nb">Function</span><span class="p">(</span> <span class="s2">&quot;rec&quot;</span><span class="p">,</span> <span class="nx">cond</span> <span class="p">)</span> <span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'>Method set</span></p>

<p>Creates or updates an existing record
Events: beforeDataSet  Fires before the record is set
        afterDataSet   Fires after the record is set, the record is the argument for listeners
        failedDataSet  Fires if the store is RESTful and the action is denied</p>

<p>Parameters:</p>

<ul>
<li><p><strong>key can be of any type.</strong><br/>([Optional] Integer or String to use as a Primary Key)</p></li>
<li><p><strong>data must be an Object.</strong><br/>(Key:Value pairs to set as field values)</p></li>
<li><p><strong>batch must be a Boolean.</strong><br/>([Optional] True if called by data.batch)</p></li>
</ul>

<p><strong>Returns an Object</strong><br/>(Deferred)</p></div></div><div class="code"><div class="wrapper"><span class="nx">DataStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">set</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">batch</span> <span class="p">)</span> <span class="p">{</span>
  <span class="nx">data</span>       <span class="o">=</span> <span class="nx">utility</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span> <span class="nx">data</span><span class="p">,</span> <span class="kc">true</span> <span class="p">);</span>
  <span class="nx">batch</span>      <span class="o">=</span> <span class="p">(</span> <span class="nx">batch</span> <span class="o">===</span> <span class="kc">true</span> <span class="p">);</span>
  <span class="kd">var</span> <span class="nx">self</span>   <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
      <span class="nx">events</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">events</span><span class="p">,</span>
      <span class="nx">defer</span>  <span class="o">=</span> <span class="nx">deferred</span><span class="p">(),</span>
      <span class="nx">record</span> <span class="o">=</span> <span class="nx">key</span> <span class="o">!==</span> <span class="kc">null</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="nx">key</span> <span class="p">)</span> <span class="o">||</span> <span class="kc">null</span> <span class="o">:</span> <span class="nx">data</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">key</span><span class="p">]</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="nx">data</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">key</span><span class="p">]</span> <span class="p">)</span> <span class="o">||</span> <span class="kc">null</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">method</span> <span class="o">=</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
      <span class="nx">parsed</span> <span class="o">=</span> <span class="nx">utility</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">uri</span> <span class="o">||</span> <span class="s2">&quot;&quot;</span> <span class="p">),</span>
      <span class="nx">uri</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">data</span> <span class="o">===</span> <span class="s2">&quot;string&quot;</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">data</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span> <span class="s2">&quot;//&quot;</span> <span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Relative path to store, i.e. a child</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span> <span class="nx">data</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span> <span class="mi">0</span> <span class="p">)</span> <span class="o">!==</span> <span class="s2">&quot;/&quot;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">uri</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">buildUri</span><span class="p">(</span> <span class="nx">data</span> <span class="p">);</span>
      <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Root path, relative to store, i.e. a domain</p></div></div><div class="code"><div class="wrapper">      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">uri</span> <span class="o">!==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">regex</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span> <span class="nx">data</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">uri</span> <span class="o">=</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">+</span> <span class="s2">&quot;//&quot;</span> <span class="o">+</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">host</span> <span class="o">+</span> <span class="nx">data</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">uri</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">uri</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">key</span> <span class="o">=</span> <span class="nx">uri</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span> <span class="nx">regex</span><span class="p">.</span><span class="nx">not_endpoint</span><span class="p">,</span> <span class="s2">&quot;&quot;</span> <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nx">string</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span> <span class="nx">label</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">invalidArguments</span> <span class="p">)</span> <span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">batch</span> <span class="o">&amp;&amp;</span> <span class="nx">events</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">observer</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span> <span class="s2">&quot;beforeDataSet&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">key</span><span class="o">:</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">data</span><span class="o">:</span> <span class="nx">data</span><span class="p">}</span> <span class="p">);</span>
      <span class="p">}</span>

      <span class="nx">client</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span> <span class="nx">uri</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">arg</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">setComplete</span><span class="p">(</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">source</span> <span class="o">?</span> <span class="nx">arg</span><span class="p">[</span><span class="nx">self</span><span class="p">.</span><span class="nx">source</span><span class="p">]</span> <span class="o">:</span> <span class="nx">arg</span><span class="p">,</span> <span class="nx">batch</span><span class="p">,</span> <span class="nx">defer</span> <span class="p">);</span>
      <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">observer</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span> <span class="s2">&quot;failedDataSet&quot;</span><span class="p">,</span> <span class="nx">e</span> <span class="p">);</span>
        <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span> <span class="nx">e</span> <span class="p">);</span>
      <span class="p">},</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">utility</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span> <span class="p">{</span><span class="nx">withCredentials</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">credentials</span><span class="p">},</span> <span class="nx">self</span><span class="p">.</span><span class="nx">headers</span> <span class="p">)</span> <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">batch</span> <span class="o">&amp;&amp;</span> <span class="nx">events</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">observer</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span> <span class="s2">&quot;beforeDataSet&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">key</span><span class="o">:</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">data</span><span class="o">:</span> <span class="nx">data</span><span class="p">}</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nx">batch</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span> <span class="o">===</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">setComplete</span><span class="p">(</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">batch</span><span class="p">,</span> <span class="nx">defer</span> <span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">key</span> <span class="o">!==</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">method</span> <span class="o">=</span> <span class="s2">&quot;PUT&quot;</span><span class="p">;</span>
        <span class="nx">uri</span>    <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">buildUri</span><span class="p">(</span> <span class="nx">key</span> <span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span> <span class="nx">client</span><span class="p">.</span><span class="nx">allows</span><span class="p">(</span> <span class="nx">uri</span><span class="p">,</span> <span class="s2">&quot;patch&quot;</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="o">!</span><span class="nx">client</span><span class="p">.</span><span class="nx">ie</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">client</span><span class="p">.</span><span class="nx">version</span> <span class="o">&gt;</span> <span class="mi">8</span> <span class="o">||</span> <span class="nx">client</span><span class="p">.</span><span class="nx">activex</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">method</span> <span class="o">=</span> <span class="s2">&quot;PATCH&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">record</span> <span class="o">!==</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">utility</span><span class="p">.</span><span class="nx">iterate</span><span class="p">(</span> <span class="nx">record</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">k</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">array</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">collections</span><span class="p">,</span> <span class="nx">k</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">data</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
              <span class="nx">data</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">});</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">uri</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="nx">client</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span> <span class="nx">uri</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">arg</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">setComplete</span><span class="p">(</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">source</span> <span class="o">?</span> <span class="nx">arg</span><span class="p">[</span><span class="nx">self</span><span class="p">.</span><span class="nx">source</span><span class="p">]</span> <span class="o">:</span> <span class="nx">arg</span><span class="p">,</span> <span class="nx">batch</span><span class="p">,</span> <span class="nx">defer</span> <span class="p">);</span>
      <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">observer</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span> <span class="s2">&quot;failedDataSet&quot;</span><span class="p">,</span> <span class="nx">e</span> <span class="p">);</span>
        <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span> <span class="nx">e</span> <span class="p">);</span>
      <span class="p">},</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">utility</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span> <span class="p">{</span><span class="nx">withCredentials</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">credentials</span><span class="p">},</span> <span class="k">this</span><span class="p">.</span><span class="nx">headers</span> <span class="p">)</span> <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">defer</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'>Method setComplete</span></p>

<p>Set completion</p>

<p>Parameters:</p>

<ul>
<li><p><strong>record can be of any type.</strong><br/>(DataStore record, or <code>null</code> if new)</p></li>
<li><p><strong>key must be a String.</strong><br/>(Record key)</p></li>
<li><p><strong>data must be an Object.</strong><br/>(Record data)</p></li>
<li><p><strong>batch must be a Boolean.</strong><br/>(<code>true</code> if part of a batch operation)</p></li>
<li><p><strong>defer must be an Object.</strong><br/>(Deferred instance)</p></li>
</ul>

<p><strong>Returns an Object</strong><br/>(DataStore instance)</p></div></div><div class="code"><div class="wrapper"><span class="nx">DataStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setComplete</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">batch</span><span class="p">,</span> <span class="nx">defer</span> <span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">self</span>      <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
      <span class="nx">deferreds</span> <span class="o">=</span> <span class="p">[];</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Clearing cached views</p></div></div><div class="code"><div class="wrapper">  <span class="k">this</span><span class="p">.</span><span class="nx">views</span> <span class="o">=</span> <span class="p">{};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Setting key</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">key</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">key</span> <span class="o">!==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">key</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">key</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">key</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">key</span> <span class="o">=</span> <span class="nx">utility</span><span class="p">.</span><span class="nx">uuid</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Removing primary key from data</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">key</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">delete</span> <span class="nx">data</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">key</span><span class="p">];</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Create</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="p">(</span> <span class="nx">record</span> <span class="o">===</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">record</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">index</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">total</span><span class="o">++</span><span class="p">,</span>
      <span class="nx">key</span>   <span class="o">:</span> <span class="nx">key</span><span class="p">,</span>
      <span class="nx">data</span>  <span class="o">:</span> <span class="nx">data</span>
    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">keys</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>                <span class="o">=</span> <span class="nx">record</span><span class="p">.</span><span class="nx">index</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">records</span><span class="p">[</span><span class="nx">record</span><span class="p">.</span><span class="nx">index</span><span class="p">]</span>    <span class="o">=</span> <span class="nx">record</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">versions</span><span class="p">[</span><span class="nx">record</span><span class="p">.</span><span class="nx">key</span><span class="p">]</span>     <span class="o">=</span> <span class="nx">lru</span><span class="p">(</span> <span class="nx">VERSIONS</span> <span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">versions</span><span class="p">[</span><span class="nx">record</span><span class="p">.</span><span class="nx">key</span><span class="p">].</span><span class="nx">nth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">retrieve</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">deferreds</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">crawl</span><span class="p">(</span> <span class="nx">record</span> <span class="p">)</span> <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Update</p></div></div><div class="code"><div class="wrapper">  <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">versioning</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">versions</span><span class="p">[</span><span class="nx">record</span><span class="p">.</span><span class="nx">key</span><span class="p">].</span><span class="nx">set</span><span class="p">(</span> <span class="s2">&quot;v&quot;</span> <span class="o">+</span> <span class="p">(</span> <span class="o">++</span><span class="k">this</span><span class="p">.</span><span class="nx">versions</span><span class="p">[</span><span class="nx">record</span><span class="p">.</span><span class="nx">key</span><span class="p">].</span><span class="nx">nth</span> <span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="nx">dump</span><span class="p">(</span> <span class="p">[</span><span class="nx">record</span><span class="p">]</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">utility</span><span class="p">.</span><span class="nx">iterate</span><span class="p">(</span> <span class="nx">data</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">k</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">array</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">collections</span><span class="p">,</span> <span class="nx">k</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">record</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">v</span> <span class="o">===</span> <span class="s2">&quot;string&quot;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">deferreds</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">record</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">k</span><span class="p">].</span><span class="nx">data</span><span class="p">.</span><span class="nx">setUri</span><span class="p">(</span> <span class="nx">record</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">k</span><span class="p">].</span><span class="nx">data</span><span class="p">.</span><span class="nx">uri</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nx">v</span><span class="p">,</span> <span class="kc">true</span> <span class="p">)</span> <span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">deferreds</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">record</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">k</span><span class="p">].</span><span class="nx">data</span><span class="p">.</span><span class="nx">batch</span><span class="p">(</span> <span class="s2">&quot;set&quot;</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="kc">true</span> <span class="p">)</span> <span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">batch</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">events</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">observer</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span> <span class="s2">&quot;afterDataSet&quot;</span><span class="p">,</span> <span class="nx">record</span> <span class="p">);</span>

    <span class="nx">array</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">datalists</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">i</span><span class="p">.</span><span class="nx">refresh</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nx">deferreds</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">defer</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span> <span class="nx">record</span> <span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="nx">utility</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span> <span class="nx">deferreds</span> <span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="nx">defer</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span> <span class="nx">record</span> <span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'>Method setExpires</span></p>

<p>Gets or sets an explicit expiration of data</p>

<p>Parameters:</p>

<ul>
<li><strong>arg must be a Number.</strong><br/>(Milliseconds until data is stale)</li>
</ul>

<p><strong>Returns an Object</strong><br/>(Data store)</p></div></div><div class="code"><div class="wrapper"><span class="nx">DataStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setExpires</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">arg</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Expiry cannot be less than a second, and must be a valid scenario for consumption; null will disable repetitive expiration</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span> <span class="nx">arg</span> <span class="o">!==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span> <span class="o">===</span> <span class="kc">null</span> <span class="p">)</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">arg</span> <span class="o">!==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="nb">isNaN</span><span class="p">(</span> <span class="nx">arg</span> <span class="p">)</span> <span class="o">||</span> <span class="nx">arg</span> <span class="o">&lt;</span> <span class="mi">1000</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span> <span class="nx">label</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">invalidArguments</span> <span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">expires</span> <span class="o">===</span> <span class="nx">arg</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">expires</span> <span class="o">=</span> <span class="nx">arg</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">id</span>      <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot;DataExpire&quot;</span><span class="p">,</span>
      <span class="nx">expires</span> <span class="o">=</span> <span class="nx">arg</span><span class="p">,</span>
      <span class="nx">self</span>    <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="nx">utility</span><span class="p">.</span><span class="nx">clearTimers</span><span class="p">(</span> <span class="nx">id</span> <span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nx">arg</span> <span class="o">===</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">utility</span><span class="p">.</span><span class="nx">repeat</span><span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">uri</span> <span class="o">===</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">setExpires</span><span class="p">(</span> <span class="kc">null</span> <span class="p">);</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">cache</span><span class="p">.</span><span class="nx">expire</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">uri</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">observer</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">uri</span><span class="p">,</span> <span class="s2">&quot;beforeExpire, expire, afterExpire&quot;</span> <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span> <span class="nx">expires</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'>Method setUri</span></p>

<p>Sets the RESTful API end point</p>

<p>Parameters:</p>

<ul>
<li><strong>arg must be a String.</strong><br/>(API collection end point)</li>
</ul>

<p><strong>Returns an Object</strong><br/>(Deferred)</p></div></div><div class="code"><div class="wrapper"><span class="nx">DataStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setUri</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">arg</span> <span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">defer</span> <span class="o">=</span> <span class="nx">deferred</span><span class="p">(),</span>
      <span class="nx">parsed</span><span class="p">,</span> <span class="nx">uri</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nx">arg</span> <span class="o">!==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">string</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span> <span class="nx">arg</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span> <span class="nx">label</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">invalidArguments</span> <span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">parsed</span> <span class="o">=</span> <span class="nx">utility</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span> <span class="nx">arg</span> <span class="p">);</span>
  <span class="nx">uri</span>    <span class="o">=</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">href</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Re-encoding the query string for the request</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="p">(</span> <span class="nx">array</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">query</span> <span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">uri</span> <span class="o">=</span> <span class="nx">uri</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span> <span class="sr">/\?.*/</span><span class="p">,</span> <span class="s2">&quot;?&quot;</span> <span class="p">);</span>

    <span class="nx">utility</span><span class="p">.</span><span class="nx">iterate</span><span class="p">(</span> <span class="nx">parsed</span><span class="p">.</span><span class="nx">query</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">k</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span> <span class="nx">v</span> <span class="k">instanceof</span> <span class="nb">Array</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">uri</span> <span class="o">+=</span> <span class="s2">&quot;&amp;&quot;</span> <span class="o">+</span> <span class="nx">k</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span> <span class="nx">v</span> <span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">array</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="nx">v</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">uri</span> <span class="o">+=</span> <span class="s2">&quot;&amp;&quot;</span> <span class="o">+</span> <span class="nx">k</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span> <span class="nx">i</span> <span class="p">);</span>
        <span class="p">}</span> <span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="p">);</span>

    <span class="nx">uri</span> <span class="o">=</span> <span class="nx">uri</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span> <span class="s2">&quot;?&amp;&quot;</span><span class="p">,</span> <span class="s2">&quot;?&quot;</span> <span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">observer</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span> <span class="p">);</span>
  <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">uri</span> <span class="o">=</span> <span class="nx">uri</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span> <span class="o">!==</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">observer</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">,</span> <span class="s2">&quot;expire&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">sync</span><span class="p">();</span>
    <span class="p">},</span> <span class="s2">&quot;dataSync&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

    <span class="nx">cache</span><span class="p">.</span><span class="nx">expire</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">,</span> <span class="kc">true</span> <span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">sync</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">arg</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">defer</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span> <span class="nx">arg</span> <span class="p">);</span>
    <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span> <span class="nx">e</span> <span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">defer</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'>Method sort</span></p>

<p>Returns a view, or creates a view and returns it
Records in a view are not by reference, they are clones</p>

<p>Parameters:</p>

<ul>
<li><p><strong>query must be a String.</strong><br/>(SQL ( style ) order by)</p></li>
<li><p><strong>create must be a String.</strong><br/>([Optional, default behavior is true, value is false] Boolean determines whether to recreate a view if it exists)</p></li>
<li><p><strong>where must be an Object.</strong><br/>([Optional] Object describing the WHERE clause)</p></li>
</ul>

<p><strong>Returns an Array</strong><br/>(View of data)</p></div></div><div class="code"><div class="wrapper"><span class="nx">DataStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">sort</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">query</span><span class="p">,</span> <span class="nx">create</span><span class="p">,</span> <span class="nx">where</span> <span class="p">)</span> <span class="p">{</span>
  <span class="nx">create</span>      <span class="o">=</span> <span class="p">(</span> <span class="nx">create</span> <span class="o">===</span> <span class="kc">true</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">where</span> <span class="k">instanceof</span> <span class="nb">Object</span> <span class="p">)</span> <span class="p">);</span>
  <span class="kd">var</span> <span class="nx">view</span>    <span class="o">=</span> <span class="nx">string</span><span class="p">.</span><span class="nx">explode</span><span class="p">(</span> <span class="nx">query</span> <span class="p">).</span><span class="nx">join</span><span class="p">(</span> <span class="s2">&quot; &quot;</span> <span class="p">).</span><span class="nx">toCamelCase</span><span class="p">(),</span>
      <span class="nx">records</span> <span class="o">=</span> <span class="o">!</span><span class="nx">where</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">records</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span> <span class="nx">where</span> <span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">total</span> <span class="o">===</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[];</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">create</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">[</span><span class="nx">view</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">[</span><span class="nx">view</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">[</span><span class="nx">view</span><span class="p">]</span> <span class="o">=</span> <span class="nx">array</span><span class="p">.</span><span class="nx">keySort</span><span class="p">(</span> <span class="nx">records</span><span class="p">.</span><span class="nx">slice</span><span class="p">(),</span> <span class="nx">query</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span> <span class="p">);</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">views</span><span class="p">[</span><span class="nx">view</span><span class="p">];</span>
  <span class="p">}</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> </span></p>

<p>Storage interface
SQL/NoSQL backends will be used if configured in lieu of localStorage (node.js only)</p>

<p>Parameters:</p>

<ul>
<li><p><strong>obj can be of any type.</strong><br/>(Record ( Object, key or index ) or store)</p></li>
<li><p><strong>op must be an Object.</strong><br/>(Operation to perform ( get, remove or set ))</p></li>
<li><p><strong>type must be a String.</strong><br/>([Optional] Type of Storage to use ( local, session [local] ))</p></li>
</ul>

<p><strong>Returns an Object</strong><br/>(Deferred)</p></div></div><div class="code"><div class="wrapper"><span class="nx">DataStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">storage</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">op</span><span class="p">,</span> <span class="nx">type</span> <span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">self</span>    <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
      <span class="nx">record</span>  <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">mongo</span>   <span class="o">=</span> <span class="o">!</span><span class="nx">string</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">mongodb</span> <span class="p">),</span>
      <span class="nx">session</span> <span class="o">=</span> <span class="p">(</span> <span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;session&quot;</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">sessionStorage</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="p">),</span>
      <span class="nx">defer</span>   <span class="o">=</span> <span class="nx">deferred</span><span class="p">(),</span>
      <span class="nx">data</span><span class="p">,</span> <span class="nx">deferreds</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">result</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">regex</span><span class="p">.</span><span class="nx">number_string_object</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span> <span class="k">typeof</span> <span class="nx">obj</span> <span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nx">regex</span><span class="p">.</span><span class="nx">get_remove_set</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span> <span class="nx">op</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span> <span class="nx">label</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">invalidArguments</span> <span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">record</span> <span class="o">=</span> <span class="p">(</span> <span class="nx">regex</span><span class="p">.</span><span class="nx">number_string</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span> <span class="k">typeof</span> <span class="nx">obj</span> <span class="p">)</span> <span class="o">||</span> <span class="p">(</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span> <span class="s2">&quot;key&quot;</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">obj</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span> <span class="s2">&quot;parentNode&quot;</span> <span class="p">)</span> <span class="p">)</span> <span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nx">op</span> <span class="o">!==</span> <span class="s2">&quot;remove&quot;</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">record</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span> <span class="nx">obj</span> <span class="k">instanceof</span> <span class="nb">Object</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">obj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="nx">obj</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">key</span> <span class="o">=</span> <span class="nx">record</span> <span class="o">?</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">key</span> <span class="o">:</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">op</span> <span class="o">===</span> <span class="s2">&quot;remove&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">record</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">key</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">key</span> <span class="o">||</span> <span class="nx">obj</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nx">op</span> <span class="o">===</span> <span class="s2">&quot;get&quot;</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">mongo</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">mongodb</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">mongodb</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">db</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span> <span class="nx">db</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="p">}</span>

          <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span> <span class="nx">e</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="nx">db</span><span class="p">.</span><span class="nx">createCollection</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">collection</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
              <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span> <span class="nx">e</span> <span class="p">);</span>
              <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">record</span> <span class="p">)</span> <span class="p">{</span>
              <span class="nx">collection</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">key</span><span class="p">}</span> <span class="p">).</span><span class="nx">limit</span><span class="p">(</span> <span class="mi">1</span> <span class="p">).</span><span class="nx">toArray</span><span class="p">(</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">recs</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
                  <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span> <span class="nx">e</span> <span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                  <span class="k">delete</span> <span class="nx">recs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">_id</span><span class="p">;</span>

                  <span class="nx">self</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">recs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">true</span> <span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">rec</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">defer</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span> <span class="nx">rec</span> <span class="p">);</span>
                  <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span> <span class="nx">e</span> <span class="p">);</span>
                  <span class="p">}</span> <span class="p">);</span>
                <span class="p">}</span>

                <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
              <span class="p">}</span> <span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
              <span class="nx">collection</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span> <span class="p">{}</span> <span class="p">).</span><span class="nx">toArray</span><span class="p">(</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">recs</span> <span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">i</span>   <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="nx">nth</span> <span class="o">=</span> <span class="nx">recs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
                
                <span class="k">if</span> <span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
                  <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span> <span class="nx">e</span> <span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span> <span class="nx">nth</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">self</span><span class="p">.</span><span class="nx">records</span> <span class="o">=</span> <span class="nx">recs</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">r</span> <span class="p">)</span> <span class="p">{</span>
                      <span class="kd">var</span> <span class="nx">rec</span> <span class="o">=</span> <span class="p">{</span><span class="nx">key</span><span class="o">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> <span class="nx">index</span><span class="o">:</span> <span class="o">++</span><span class="nx">i</span><span class="p">,</span> <span class="nx">data</span><span class="o">:</span> <span class="p">{}};</span>

                      <span class="nx">self</span><span class="p">.</span><span class="nx">keys</span><span class="p">[</span><span class="nx">rec</span><span class="p">.</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">rec</span><span class="p">.</span><span class="nx">index</span><span class="p">;</span>
                      <span class="nx">rec</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">r</span><span class="p">;</span>
                      <span class="k">delete</span> <span class="nx">rec</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">_id</span><span class="p">;</span>

                      <span class="k">return</span> <span class="nx">rec</span><span class="p">;</span>
                    <span class="p">}</span> <span class="p">);</span>
                    
                    <span class="nx">self</span><span class="p">.</span><span class="nx">total</span> <span class="o">=</span> <span class="nx">nth</span><span class="p">;</span>
                  <span class="p">}</span>
                  
                  <span class="nx">defer</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">records</span> <span class="p">);</span>
                <span class="p">}</span>

                <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
              <span class="p">}</span> <span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span> <span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">result</span> <span class="o">=</span> <span class="nx">session</span> <span class="o">?</span> <span class="nx">sessionStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span> <span class="nx">key</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span> <span class="nx">key</span> <span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span> <span class="nx">result</span> <span class="o">!==</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">decode</span><span class="p">(</span> <span class="nx">result</span> <span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span> <span class="nx">record</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="kc">true</span> <span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">rec</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">defer</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span> <span class="nx">rec</span> <span class="p">);</span>
          <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span> <span class="nx">e</span> <span class="p">);</span>
          <span class="p">}</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="nx">utility</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span> <span class="nx">self</span><span class="p">,</span> <span class="nx">result</span> <span class="p">);</span>
          <span class="nx">defer</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span> <span class="nx">self</span> <span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">defer</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span> <span class="nx">self</span> <span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">op</span> <span class="o">===</span> <span class="s2">&quot;remove&quot;</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">mongo</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">mongodb</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">mongodb</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">db</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span> <span class="nx">db</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="p">}</span>

          <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span> <span class="nx">e</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="nx">db</span><span class="p">.</span><span class="nx">createCollection</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">collection</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span> <span class="nx">db</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
              <span class="p">}</span>

              <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span> <span class="nx">e</span> <span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
              <span class="nx">collection</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span> <span class="nx">record</span> <span class="o">?</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="nx">key</span><span class="p">}</span> <span class="o">:</span> <span class="p">{},</span> <span class="p">{</span><span class="nx">safe</span><span class="o">:</span> <span class="kc">true</span><span class="p">},</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">arg</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
                  <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span> <span class="nx">e</span> <span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                  <span class="nx">defer</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span> <span class="nx">arg</span> <span class="p">);</span>
                <span class="p">}</span>

                <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
              <span class="p">}</span> <span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span> <span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">session</span> <span class="o">?</span> <span class="nx">sessionStorage</span><span class="p">.</span><span class="nx">removeItem</span><span class="p">(</span> <span class="nx">key</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">localStorage</span><span class="p">.</span><span class="nx">removeItem</span><span class="p">(</span> <span class="nx">key</span> <span class="p">);</span>
      <span class="nx">defer</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span> <span class="k">this</span> <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">op</span> <span class="o">===</span> <span class="s2">&quot;set&quot;</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">mongo</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">mongodb</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">mongodb</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">db</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span> <span class="nx">db</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
          <span class="p">}</span>

          <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span> <span class="nx">e</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="nx">db</span><span class="p">.</span><span class="nx">createCollection</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">collection</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
              <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span> <span class="nx">e</span> <span class="p">);</span>
              <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">record</span> <span class="p">)</span> <span class="p">{</span>
              <span class="nx">collection</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">key</span><span class="p">},</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">data</span><span class="p">},</span> <span class="p">{</span><span class="nx">w</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">safe</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">upsert</span><span class="o">:</span> <span class="kc">true</span><span class="p">},</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">arg</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
                  <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span> <span class="nx">e</span> <span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                  <span class="nx">defer</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span> <span class="nx">arg</span> <span class="p">);</span>
                <span class="p">}</span>

                <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
              <span class="p">}</span> <span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Removing all documents &amp; re-inserting</p></div></div><div class="code"><div class="wrapper">              <span class="nx">collection</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span> <span class="p">{},</span> <span class="p">{</span><span class="nx">w</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">safe</span><span class="o">:</span> <span class="kc">true</span><span class="p">},</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
                  <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span> <span class="nx">e</span> <span class="p">);</span>
                  <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                  <span class="nx">deferreds</span> <span class="o">=</span> <span class="p">[];</span>

                  <span class="nx">array</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">records</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">data</span>   <span class="o">=</span> <span class="p">{},</span>
                        <span class="nx">defer2</span> <span class="o">=</span> <span class="nx">deferred</span><span class="p">();</span>

                    <span class="nx">deferreds</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">defer2</span> <span class="p">);</span>

                    <span class="nx">utility</span><span class="p">.</span><span class="nx">iterate</span><span class="p">(</span> <span class="nx">i</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">k</span> <span class="p">)</span> <span class="p">{</span>
                      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">array</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">collections</span><span class="p">,</span> <span class="nx">k</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">data</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span><span class="p">;</span>
                      <span class="p">}</span>
                    <span class="p">}</span> <span class="p">);</span>

                    <span class="nx">collection</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="nx">i</span><span class="p">.</span><span class="nx">key</span><span class="p">},</span> <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="nx">data</span><span class="p">},</span> <span class="p">{</span><span class="nx">w</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">safe</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="nx">upsert</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">arg</span> <span class="p">)</span> <span class="p">{</span>
                      <span class="k">if</span> <span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">defer2</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span> <span class="nx">e</span> <span class="p">);</span>
                      <span class="p">}</span>
                      <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">defer2</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span> <span class="nx">arg</span> <span class="p">);</span>
                      <span class="p">}</span>
                    <span class="p">}</span> <span class="p">);</span>
                  <span class="p">}</span> <span class="p">);</span>

                  <span class="nx">utility</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span> <span class="nx">deferreds</span> <span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">result</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">defer</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span> <span class="nx">result</span> <span class="p">);</span>
                    <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
                  <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span> <span class="nx">e</span> <span class="p">);</span>
                    <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
                  <span class="p">}</span> <span class="p">);</span>
                <span class="p">}</span>
              <span class="p">}</span> <span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span> <span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">data</span> <span class="o">=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span> <span class="nx">record</span> <span class="o">?</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">data</span> <span class="o">:</span> <span class="p">{</span><span class="nx">total</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">total</span><span class="p">,</span> <span class="nx">keys</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">records</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">records</span><span class="p">}</span> <span class="p">);</span>
      <span class="nx">session</span> <span class="o">?</span> <span class="nx">sessionStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">data</span> <span class="p">)</span> <span class="o">:</span> <span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">data</span> <span class="p">);</span>
      <span class="nx">defer</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span> <span class="k">this</span> <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">defer</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'>Method sync</span></p>

<p>Syncs the DataStore with a URI representation
Events: beforeDataSync  Fires before syncing the DataStore
        afterDataSync   Fires after syncing the DataStore
        failedDataSync  Fires when an exception occurs</p>

<p><strong>Returns an Object</strong><br/>(Deferred)</p></div></div><div class="code"><div class="wrapper"><span class="nx">DataStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">sync</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">string</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span> <span class="nx">label</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">invalidArguments</span> <span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">self</span>   <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
      <span class="nx">events</span> <span class="o">=</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">events</span> <span class="o">===</span> <span class="kc">true</span> <span class="p">),</span>
      <span class="nx">defer</span>  <span class="o">=</span> <span class="nx">deferred</span><span class="p">(),</span>
      <span class="nx">success</span><span class="p">,</span> <span class="nx">failure</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments doc-section doc-section-private"><div class="wrapper"><p><span class='doc-section-header'>Private method success</span></p>

<p>Resolves public deferred</p>

<p>Parameters:</p>

<ul>
<li><strong>arg must be an Object.</strong><br/>(API response)</li>
</ul>

<p><strong>Returns an Undefined</strong><br/>(undefined)</p></div></div><div class="code"><div class="wrapper">  <span class="nx">success</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">arg</span> <span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">data</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span> <span class="k">typeof</span> <span class="nx">arg</span> <span class="o">!==</span> <span class="s2">&quot;object&quot;</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span> <span class="nx">label</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">expectedObject</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">source</span> <span class="o">!==</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">arg</span> <span class="o">=</span> <span class="nx">utility</span><span class="p">.</span><span class="nx">walk</span><span class="p">(</span> <span class="nx">arg</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">source</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nx">arg</span> <span class="k">instanceof</span> <span class="nb">Array</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">data</span> <span class="o">=</span> <span class="nx">arg</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">data</span> <span class="o">=</span> <span class="p">[</span><span class="nx">arg</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">batch</span><span class="p">(</span> <span class="s2">&quot;set&quot;</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="kc">true</span> <span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">arg</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">events</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">observer</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span> <span class="s2">&quot;afterDataSync&quot;</span><span class="p">,</span> <span class="nx">arg</span> <span class="p">);</span>
      <span class="p">}</span>

      <span class="nx">defer</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span> <span class="nx">arg</span> <span class="p">);</span>
    <span class="p">},</span> <span class="nx">failure</span><span class="p">);</span>
  <span class="p">};</span></div></div></div><div class="segment"><div class="comments doc-section doc-section-private"><div class="wrapper"><p><span class='doc-section-header'>Private method failure</span></p>

<p>Rejects public deferred</p>

<p>Parameters:</p>

<ul>
<li><strong>e must be an Object.</strong><br/>(Error instance)</li>
</ul>

<p><strong>Returns an Undefined</strong><br/>(undefined)</p></div></div><div class="code"><div class="wrapper">  <span class="nx">failure</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">events</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">observer</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span> <span class="nx">self</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span> <span class="s2">&quot;failedDataSync&quot;</span><span class="p">,</span> <span class="nx">e</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span> <span class="nx">e</span> <span class="p">);</span>
  <span class="p">};</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nx">events</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">observer</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span> <span class="s2">&quot;beforeDataSync&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span> <span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">callback</span> <span class="o">!==</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">jsonp</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">success</span><span class="p">,</span> <span class="nx">failure</span><span class="p">,</span> <span class="p">{</span><span class="nx">callback</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">callback</span><span class="p">}</span> <span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="nx">success</span><span class="p">,</span> <span class="nx">failure</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">utility</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span> <span class="p">{</span><span class="nx">withCredentials</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">credentials</span><span class="p">},</span> <span class="k">this</span><span class="p">.</span><span class="nx">headers</span><span class="p">)</span> <span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">defer</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'>Method teardown</span></p>

<p>Tears down a store &amp; expires all records associated to an API</p>

<p><strong>Returns an Undefined</strong><br/>(undefined)</p></div></div><div class="code"><div class="wrapper"><span class="nx">DataStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">teardown</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">uri</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">,</span>
      <span class="nx">id</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nx">uri</span> <span class="o">!==</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">cache</span><span class="p">.</span><span class="nx">expire</span><span class="p">(</span> <span class="nx">uri</span><span class="p">,</span> <span class="kc">true</span> <span class="p">);</span>
    <span class="nx">observer</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span> <span class="nx">uri</span> <span class="p">);</span>

    <span class="nx">id</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot;DataExpire&quot;</span><span class="p">;</span>
    <span class="nx">utility</span><span class="p">.</span><span class="nx">clearTimers</span><span class="p">(</span> <span class="nx">id</span> <span class="p">);</span>

    <span class="nx">array</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">datalists</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">i</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">i</span><span class="p">.</span><span class="nx">teardown</span><span class="p">();</span>
    <span class="p">});</span>

    <span class="nx">array</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">records</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">recordUri</span> <span class="o">=</span> <span class="nx">uri</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">.</span><span class="nx">key</span><span class="p">;</span>

      <span class="nx">cache</span><span class="p">.</span><span class="nx">expire</span><span class="p">(</span> <span class="nx">recordUri</span><span class="p">,</span> <span class="kc">true</span> <span class="p">);</span>
      <span class="nx">observer</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span> <span class="nx">recordUri</span> <span class="p">);</span>

      <span class="nx">utility</span><span class="p">.</span><span class="nx">iterate</span><span class="p">(</span> <span class="nx">i</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">v</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">v</span> <span class="o">===</span> <span class="kc">null</span> <span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span> <span class="nx">v</span><span class="p">.</span><span class="nx">data</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">v</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">teardown</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">observer</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span> <span class="nx">v</span><span class="p">.</span><span class="nx">id</span> <span class="p">);</span>
          <span class="nx">v</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">teardown</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">clear</span><span class="p">(</span> <span class="kc">true</span> <span class="p">);</span>
  <span class="nx">observer</span><span class="p">.</span><span class="nx">fire</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span> <span class="s2">&quot;afterDataTeardown&quot;</span> <span class="p">);</span>

  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'>Method undo</span></p>

<p>Undoes the last modification to a record, if it exists</p>

<p>Parameters:</p>

<ul>
<li><p><strong>key can be of any type.</strong><br/>(Key or index)</p></li>
<li><p><strong>version must be a String.</strong><br/>([Optional] Version to restore)</p></li>
</ul>

<p><strong>Returns an Object</strong><br/>(Deferred)</p></div></div><div class="code"><div class="wrapper"><span class="nx">DataStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">undo</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">version</span> <span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">record</span>   <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="nx">key</span> <span class="p">),</span>
      <span class="nx">defer</span>    <span class="o">=</span> <span class="nx">deferred</span><span class="p">(),</span>
      <span class="nx">versions</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">versions</span><span class="p">[</span><span class="nx">record</span><span class="p">.</span><span class="nx">key</span><span class="p">],</span>
      <span class="nx">previous</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nx">record</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span> <span class="nx">label</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">invalidArguments</span> <span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nx">versions</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">previous</span> <span class="o">=</span> <span class="nx">versions</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="nx">version</span> <span class="o">||</span> <span class="nx">versions</span><span class="p">.</span><span class="nx">first</span> <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nx">previous</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span> <span class="nx">label</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">datastoreNoPrevVersion</span> <span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">previous</span> <span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">arg</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">defer</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span> <span class="nx">arg</span> <span class="p">);</span>
      <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span> <span class="nx">e</span> <span class="p">);</span>
      <span class="p">}</span> <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span> <span class="nx">label</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">datastoreNoPrevVersion</span> <span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">defer</span><span class="p">;</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'>Method unique</span></p>

<p>Returns Array of unique values of <code>key</code></p>

<p>Parameters:</p>

<ul>
<li><strong>key must be a String.</strong><br/>(Field to compare)</li>
</ul>

<p><strong>Returns an Array</strong><br/>(Array of values)</p></div></div><div class="code"><div class="wrapper"><span class="nx">DataStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">unique</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">key</span> <span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">array</span><span class="p">.</span><span class="nx">unique</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">records</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">i</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">i</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
  <span class="p">}));</span>
<span class="p">};</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'>Method update</span></p>

<p>Applies a difference to a record
Use <code>data.set()</code> if <code>data</code> is the complete field set</p>

<p>Parameters:</p>

<ul>
<li><p><strong>key can be of any type.</strong><br/>(Key or index)</p></li>
<li><p><strong>data must be an Object.</strong><br/>(Key:Value pairs to set as field values)</p></li>
</ul>

<p><strong>Returns an Object</strong><br/>(Deferred)</p></div></div><div class="code"><div class="wrapper"><span class="nx">DataStore</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">data</span> <span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">record</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="nx">key</span> <span class="p">),</span>
      <span class="nx">defer</span>  <span class="o">=</span> <span class="nx">deferred</span><span class="p">();</span>

  <span class="k">if</span> <span class="p">(</span> <span class="nx">record</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span> <span class="nx">label</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">invalidArguments</span> <span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">utility</span><span class="p">.</span><span class="nx">iterate</span><span class="p">(</span> <span class="nx">record</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">k</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">data</span><span class="p">[</span><span class="nx">v</span><span class="p">]</span> <span class="o">=</span> <span class="nx">k</span><span class="p">;</span>
  <span class="p">});</span>
  
  <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">data</span> <span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">arg</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">defer</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span> <span class="nx">arg</span> <span class="p">);</span>
  <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span> <span class="nx">e</span> <span class="p">);</span>
  <span class="p">});</span>

  <span class="k">return</span> <span class="nx">defer</span><span class="p">;</span>
<span class="p">};</span></div></div></div></div></body></html>